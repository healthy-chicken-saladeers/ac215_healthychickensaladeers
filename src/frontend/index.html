<!DOCTYPE html>
<html>
<head>
    <title>üîç Rag Detective</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
    <header class="mdc-top-app-bar">
        <div class="mdc-top-app-bar__row">
            <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
                <button class="material-icons mdc-top-app-bar__navigation-icon mdc-icon-button"
                    aria-label="Open navigation menu">menu</button>
                <span class="mdc-top-app-bar__title">üîç Rag Detective</span>
            </section>
        </div>
    </header>

    <div class="content">
        <label for="websiteDropdown">Select website:</label>
        <select id="websiteDropdown" onchange="updateScrapeSession()">
            <option value="" selected>Please select</option>
        </select>

        <label for="scrapeSessionDropdown">Scrape session:</label>
        <select id="scrapeSessionDropdown">
            <!-- Options will be populated based on website selection -->
        </select>

        <label for="promptInput">Enter prompt:</label>
        <textarea id="promptInput" placeholder="Type prompt here..."></textarea>
        <button id="searchButton" onclick="generate_response()">Search</button>
        
        <!-- Output Section with Overlay -->
        <div id="outputSection" style="position: relative;">
            <textarea id="output" readonly></textarea>
            <!-- Loading Overlay -->
            <div id="loadingOverlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); justify-content: center; align-items: center;">
                <div class="spinner"></div>
            </div>
        </div>
        <div id="urlsContainer">
            <!-- URLs will be listed here -->
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Populate the websites dropdown on initial load
        fetchWebsites();
    });

    function fetchWebsites() {
        fetch('http://localhost:9000/websites')
            .then(response => response.json())
            .then(websites => {
                const websiteDropdown = document.getElementById('websiteDropdown');
                websites.forEach(website => {
                    const option = document.createElement('option');
                    option.value = website;
                    option.textContent = website;
                    websiteDropdown.appendChild(option);
                });
            })
            .catch(error => console.error('Error fetching websites:', error));
    }

    function updateScrapeSession() {
        const websiteDropdown = document.getElementById('websiteDropdown');
        const website = websiteDropdown.value;
        const scrapeSessionDropdown = document.getElementById('scrapeSessionDropdown');

        // Clear out the scrape session dropdown
        scrapeSessionDropdown.innerHTML = '';

        if (!website || website === 'Please select') {
            return;
        }

        fetch(`http://localhost:9000/timestamps/${website}`)
            .then(response => response.json())
            .then(timestamps => {
                const scrapeSessionDropdown = document.getElementById('scrapeSessionDropdown');
                scrapeSessionDropdown.innerHTML = ''; // Clear existing options
                timestamps.forEach(timestamp => {
                    const option = document.createElement('option');
                    option.value = timestamp;
                    option.textContent = timestamp;
                    scrapeSessionDropdown.appendChild(option);
                });
            })
            .catch(error => console.error('Error fetching timestamps:', error));
    }

    // Update this to use the website, timestamp, and query fields
    function generate_response() {
        // Get the overlay, spinner, and output elements
        const loadingOverlay = document.getElementById('loadingOverlay');
        const outputElement = document.getElementById('output');
        const urlsContainer = document.getElementById('urlsContainer');

        // Retrieve values from the dropdown and the prompt input
        const websiteDropdown = document.getElementById('websiteDropdown');
        const website = websiteDropdown.options[websiteDropdown.selectedIndex].value;

        if (!website || website === 'Please select') {
            alert('Please select a website before searching.');
            return;
        }

        // Clear previous output and show the overlay with spinner
        outputElement.value = '';
        urlsContainer.innerHTML = '';
        loadingOverlay.style.display = 'flex'; // Show overlay

        // Added: Retrieve the timestamp from the scrapeSessionDropdown
        const scrapeSessionDropdown = document.getElementById('scrapeSessionDropdown');
        const timestamp = scrapeSessionDropdown.options[scrapeSessionDropdown.selectedIndex].value;

        const query = document.getElementById('promptInput').value;
        
        const postData = {
            website: website,
            timestamp: timestamp,
            query: query
        };

        // Using fetch with a POST request
        fetch('http://localhost:9000/rag_query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(postData)
        }).then(response => {
            // Assuming your server is designed to send the final query_id as a response header
            const queryId = response.headers.get('X-Query-ID');
            const reader = response.body.getReader();
            function processText({ done, value }) {
                loadingOverlay.style.display = 'none';
                if (done) {
                    // Here, call the function to fetch URLs with the received query_id
                    fetchURLs(queryId);
                    return;
                }
                outputElement.value += new TextDecoder().decode(value, { stream: true });
                reader.read().then(processText); // Keep reading the next chunk of data
            }
            reader.read().then(processText);
        }).catch(err => {
            outputElement.value = `Fetch error: ${err.message}`;
            loadingOverlay.style.display = 'none'; // Hide overlay on error
        });
    }


    function fetchURLs(queryId) {
        if (queryId) {
            // Make the GET request to the get_urls endpoint
            fetch(`http://localhost:9000/get_urls/${queryId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.urls) {
                        displayURLs(data.urls); // Call a function to display URLs
                    } else {
                        throw new Error('URLs not found.');
                    }
                })
                .catch(error => {
                    console.error('Error fetching URLs:', error);
                    const urlsContainer = document.getElementById('urlsContainer');
                    urlsContainer.textContent = 'Error fetching URLs.';
                });
        } else {
           console.error('Query ID not found.');
        }
    }

    function displayURLs(urls) {
        // Assuming there's a container for URLs
        const urlsContainer = document.getElementById('urlsContainer');
        urlsContainer.innerHTML = 'The following pages were used to generate this answer:'; // Clear previous URLs

        // Update the HTML with the new URLs
        const ulElement = document.createElement('ul');
        urls.forEach(function(url) {
            const li = document.createElement('li');
            li.textContent = url;
            ulElement.appendChild(li);
        });
        urlsContainer.appendChild(ulElement);
    }
    </script>

</body>
</html>
